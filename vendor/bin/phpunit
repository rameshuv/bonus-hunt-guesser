#!/usr/bin/env php
<?php
$root = dirname(__DIR__, 1);
$projectRoot = dirname($root);

require_once $projectRoot . '/tests/support/phpunit-stubs.php';

$bootstrap = $projectRoot . '/tests/bootstrap.php';
if (file_exists($bootstrap)) {
    require_once $bootstrap;
}

foreach (glob($projectRoot . '/tests/*Test.php') as $file) {
    require_once $file;
}

use PHPUnit\Framework\TestCase;
use PHPUnit\Framework\AssertionFailedError;

$testClasses = array();
foreach (get_declared_classes() as $class) {
    if (is_subclass_of($class, TestCase::class)) {
        $testClasses[] = $class;
    }
}

$testsRun      = 0;
$assertions    = 0;
$failures      = array();
$startTime     = microtime(true);

foreach ($testClasses as $class) {
    $refClass = new ReflectionClass($class);
    $methods  = array_filter(
        $refClass->getMethods(ReflectionMethod::IS_PUBLIC),
        static function (ReflectionMethod $method) {
            return 0 === strpos($method->getName(), 'test');
        }
    );

    $setUp    = $refClass->hasMethod('setUp') ? $refClass->getMethod('setUp') : null;
    $tearDown = $refClass->hasMethod('tearDown') ? $refClass->getMethod('tearDown') : null;
    if ($setUp) {
        $setUp->setAccessible(true);
    }
    if ($tearDown) {
        $tearDown->setAccessible(true);
    }

    foreach ($methods as $method) {
        $testsRun++;
        $instance = $refClass->newInstance();

        try {
            if ($setUp) {
                $setUp->invoke($instance);
            }

            $method->invoke($instance);

            if ($tearDown) {
                $tearDown->invoke($instance);
            }

            if (method_exists($instance, 'getNumAssertions')) {
                $assertions += (int) $instance->getNumAssertions();
            }
        } catch (AssertionFailedError $e) {
            $failures[] = array(
                'class'   => $class,
                'method'  => $method->getName(),
                'message' => $e->getMessage(),
            );
        } catch (Throwable $t) {
            $failures[] = array(
                'class'   => $class,
                'method'  => $method->getName(),
                'message' => $t->getMessage(),
            );
        }
    }
}

$duration = microtime(true) - $startTime;

if (empty($failures)) {
    printf("OK (%d tests, %d assertions) in %.4fs\n", $testsRun, $assertions, $duration);
    exit(0);
}

echo "Failures:\n";
foreach ($failures as $index => $failure) {
    $num = $index + 1;
    printf("%d) %s::%s\n   %s\n", $num, $failure['class'], $failure['method'], $failure['message']);
}

printf("\nFAILURES! Tests: %d, Assertions: %d, Failures: %d.\n", $testsRun, $assertions, count($failures));
exit(1);
